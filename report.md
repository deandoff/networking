# Сети в Linux

## Part 1. Инструмент ipcalc

### 1.1 Сети и маски

*************************************************************************************************************************
- Определение адреса сети 192.167.38.54/13: ipcalc 192.167.38.54/13
![2.png](images/2.png)

> Результат выполнения команды ipcalc 192.167.38.54/13
*************************************************************************************************************************
- Для перевода маски 255.255.255.0 в префиксную и двоичную запись выполним команду: ipcalc 255.255.255.0
![3.png](images/3.png)

> Перевод маски 255.255.255.0 в префиксную и двоичную запись
*************************************************************************************************************************
- Для перевода /15 в обычную и двоичную запись выполним команду: ipcalc /15
![4.png](images/4.png)

> Перевод маски /15 в обычную и двоичную запись
*************************************************************************************************************************
- Для перевода 11111111.11111111.11111111.11110000 в обычную и префиксную запись выполним команду: ipcalc 255.255.255.240
![5.png](images/5.png)

> Перевод 11111111.11111111.11111111.11110000 в обычную и префиксную запись
*************************************************************************************************************************
- Минимальный и максимальный хост в сети 12.167.38.4 при маске: /8
![6.png](images/6.png)

>Минимальный хост 12.0.0.1. Максимальный хост: 12.255.255.254
*************************************************************************************************************************
- Минимальный и максимальный хост в сети 12.167.38.4 при маске: 11111111.11111111.00000000.00000000
![7.png](images/7.png)

>Минимальный хост 12.0.0.1. Максимальный хост: 12.255.255.254
*************************************************************************************************************************
- Минимальный и максимальный хост в сети 12.167.38.4 при маске: 255.255.254.0
![8.png](images/8.png)

>Минимальный хост 12.167.38.1. Максимальный хост: 12.167.39.254
*************************************************************************************************************************
- Минимальный и максимальный хост в сети 12.167.38.4 при маске: /4
![9.png](images/9.png)

>Минимальный хост 0.0.0.1. Максимальный хост: 15.255.255.254
*************************************************************************************************************************

### 1.2 localhost

- Определяем, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1 с помощью команды ping
![10.png](images/10.png)

>Можно обратиться к 127.0.0.2 и 127.1.0.1. Пакеты с IP 194.34.23.100 и 128.0.0.1 - 100% packet loss
*************************************************************************************************************************

### 1.3 Диапазоны и сегменты сетей

- Определяем публичные и частные ip 10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1 с помощью ipcalc
![11.1.png](images/11.1.png)
![11.2.png](images/11.2.png)
![11.3.png](images/11.3.png)
![11.4.png](images/11.4.png)

> Частные адреса: 10.0.0.45, 192.168.4.2, 172.20.250.4, 172.16.255.255, 10.10.10.10. 
> Публичные адреса: 134.43.0.2, 172.0.2.1, 192.172.0.1, 172.68.0.2, 192.169.168.1.
*************************************************************************************************************************
- Определим какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255
![12.1.png](images/12.1.png)
![12.2.png](images/12.2.png)


> Из перечисленных IP-адресов шлюза, только 10.10.0.2 и 10.10.1.255 возможны для сети 10.10.0.0/18. 10.0.0.1, 10.10.10.10 и 10.10.100.1 не входят в диапазон адресов данной сети. 
*************************************************************************************************************************

## Part 2. Статическая маршрутизация между двумя машинами

*************************************************************************************************************************
- Выполним ip -a для ws1 и ws2
- ws1:
![14.1.png](images/14.1.png)
- ws2:
![14.2.png](images/14.2.png)
*************************************************************************************************************************
- Изменим файлы etc/netplan/00-installer-config.yaml, пропишем IP для ws1 и ws2 и выполним netplan apply для перезапуска сервиса сети
- ws1:
![15.1.png](images/15.1.png)
- ws2:
![15.2.png](images/15.2.png)

*************************************************************************************************************************

### 2.1. Добавление статического маршрута вручную
- Добавим статический маршрут от одной машины до другой и обратно при помощи команды вида ip r add
Пропингуем соединение между машинами

- ws1 -> ws2:
![16.1.png](images/16.1.png)
- ws2 -> ws1:
![16.2.png](images/16.2.png)

### 2.2. Добавление статического маршрута с сохранением
- Добавим статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml
- ws1:
![17.1.png](images/17.1.png)
- ws2:
![17.2.png](images/17.2.png)

- Пропингуем:
- ws1 -> ws2:
![17.3.png](images/17.3.png)
- ws2 -> ws1:
![17.4.png](images/17.4.png)

## Part 3. Утилита iperf3

### 3.1 Скорость соединения

- 8 Mbps = 1 MB/s
- 100 MB/s = 819200 Kbps
- 1 Gbps = 1024 Mbps

### 3.2. Утилита iperf3

- Измерим скорость соединения между ws1 и ws2
![18.1.png](images/18.1.png)
![18.2.png](images/18.2.png)

## Part 4. Сетевой экран

### 4.1 Утилита iptables

- Содержание файлов /etc/firewall.sh + chmod +x /etc/firewall.sh запуск /etc/firewall.sh и ping между машинами ws1 и ws2:

![19.1.png](images/19.1.png)
![19.2.png](images/19.2.png)
![19.3.png](images/19.3.png)
![19.4.png](images/19.4.png)


### 4.2 Утилита nmap

Командой ping найдём машину, которая не пингуется, после чего утилитой nmap посмотрим, что хост машины запущен
![20.1.png](images/20.1.png)
![20.2.png](images/20.2.png)

*************************************************************************************************************************

## Part 5. Статическая маршрутизация сети


### 5.1 Настройка адресов машин

Настроим конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке.
![22.png](images/22.png)

Отредактируем содержание файлов etc/netplan/00-installer-config.yaml для каждой машины.
- r1:
![23.1.png](images/23.1.png)
- ws21:
![23.2.png](images/23.2.png)
- r2:
![23.3.png](images/23.3.png)
- ws22:
![23.4.png](images/23.4.png)
- ws11:
![23.5.png](images/23.5.png)

*************************************************************************************************************************
- Командой ip -4 a проверим, что адреса машин заданы верно. 
![24.1.png](images/24.1.png)
![24.2.png](images/24.2.png)
![24.3.png](images/24.3.png)
![24.4.png](images/24.4.png)

- Пропингуем ws22 с ws21.
![24.6.png](images/24.6.png)

- Пропингуем r1 с ws11.
![24.5.png](images/24.5.png)


### 5.2 Включение переадресации IP-адресов

Для включения переадресации IP, выполним команду на роутерах: sysctl -w net.ipv4.ip_forward=1
При таком подходе переадресация не будет работать после перезагрузки системы.
![25.1.png](images/25.1.png)
![25.2.png](images/25.2.png)

*************************************************************************************************************************
Откроем файлы /etc/sysctl.conf и раскомментируем строки:
net.ipv4.ip_forward = 1
При использовании этого подхода, IP-переадресация включится на постоянной основе.

![26.1.png](images/26.1.png)
![26.2.png](images/26.2.png)


### 5.3 Установка маршрута по-умолчанию

Настроим маршруты по-умолчанию (шлюз) для рабочих станций. Для этого добавим default перед IP роутера в файлах конфигураций.
![27.1.png](images/27.1.png)
![27.2.png](images/27.2.png)
![27.3.png](images/27.3.png)

*************************************************************************************************************************
Пропингуем с ws11 роутер r2 и посмотрим на r2, что пинг доходит. Для этого используем команду: `tcpdump -tn -i eth1` на r2
![28.1.png](images/28.1.png)
![28.2.png](images/28.2.png)

### 5.4 Добавление статических маршрутов

Добавим в роутеры r1 и r2 статические маршруты в файле конфигураций etc/netplan/00-installer-config.yaml. Вызовем ip r и посмотрим таблицы с маршрутами на обоих роутерах. 
![29.1.png](images/29.1.png)
![29.2.png](images/29.2.png)

*************************************************************************************************************************

![30.png](images/30.png)

### 5.5 Построение списка маршрутизаторов

Запустим на r1 команду дампа: tcpdump -tnv -i eth0
При помощи утилиты traceroute построим список маршрутизаторов на пути от ws11 до ws21
![31.png](images/31.png)

![32.png](images/32.png)


### 5.6 Использование протокола ICMP при маршрутизации

Запустим на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды: `tcpdump -n -i eth0 icmp`
![33.1.png](images/33.1.png)
Пропингуем с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды: `ping -c 1 10.30.0.111`
![33.2.png](images/33.2.png)

## Part 6. Динамическая настройка IP с помощью DHCP

Для r2 настроим в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:
Укажем адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.
В файле /etc/resolv.conf пропишем nameserver 8.8.8.8.
Перезагрузим службу DHCP командой systemctl restart isc-dhcp-server. 
![34.1.png](images/34.1.png)
![34.2.png](images/34.2.png)

*************************************************************************************************************************
Машину ws21 перезагрузим при помощи reboot и через ip a покажем, что она получила адрес. Также пропингуем ws22 с ws21.
![35.png](images/35.png)

*************************************************************************************************************************
Указажем/изменим MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml добавим (изменим) строки: macaddress: 10:10:10:10:10:BA, dhcp4: true
![36.png](images/36.png)

*************************************************************************************************************************
Для r1 настроим в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:
Укажем адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.
В файле /etc/resolv.conf пропишем nameserver 8.8.8.8.
Перезагрузим службу DHCP командой systemctl restart isc-dhcp-server. 
![37.1.png](images/37.1.png)
![37.2.png](images/37.2.png)

*************************************************************************************************************************
Машину ws11 перезагрузим при помощи reboot и через ip a покажем, что она получила адрес. Также пропингуем ws22 с ws11.
![38.png](images/38.png)

*************************************************************************************************************************
Указажем/изменим MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml добавим (изменим) строки: macaddress: 10:10:10:10:10:BA, dhcp4: true
![39.png](images/39.png)

*************************************************************************************************************************
Вызовем ip a для просмотра текущего IP. Поправим для ws21 файлы /etc/dhcp/dhcpd.conf, /etc/resolv.conf для настройки получения динамического IP машиной. Выполним команду dhclient -v для запроса нового IP. 
![40.1.png](images/40.1.png)
![40.2.png](images/40.2.png)
![40.3.png](images/40.3.png)

Сохраним дампы образов виртуальных машин.

## Part 7. NAT

В файлах /etc/apache2/ports.conf на ws22 и r1 изменим строку Listen 80 на Listen 0.0.0.0:80, то есть сделаем сервер Apache2 общедоступным
![42.1.png](images/42.1.png)
![42.2.png](images/42.2.png)

*************************************************************************************************************************
Запустим веб-серверы Apache командой service apache2 start на ws22 и r1
![43.1.png](images/43.1.png)
![43.2.png](images/43.2.png)

*************************************************************************************************************************
Добавим в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:
1) удаление правил в таблице filter - iptables -F
2) удаление правил в таблице "NAT" - iptables -F -t nat
3) отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP
![44.png](images/44.png)

*************************************************************************************************************************
Проверим соединение между ws22 и r1 командой ping
При запуске файла с этими правилами, ws22 не должна "пинговаться" с r1
![45.1.png](images/45.1.png)
![45.2.png](images/45.2.png)

*************************************************************************************************************************
Разрешим маршрутизацию всех пакетов протокола ICMP
![46.png](images/46.png)

*************************************************************************************************************************
Проверим соединение между ws22 и r1 командой ping
![47.png](images/47.png)

*************************************************************************************************************************
Добавим в файл ещё два правила:
- включим SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2
- включим DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети
![48.png](images/48.png)

*************************************************************************************************************************
Проверим соединение по TCP для SNAT, для этого с ws22 подключимся к серверу Apache на r1
![49.png](images/49.png)

*************************************************************************************************************************
Проверим соединение по TCP для DNAT, для этого с r1 подключимся к серверу Apache на ws22 командой telnet (по адресу r2 и порту 8080)
![50.png](images/50.png)

*************************************************************************************************************************
Сохраним дампы образов виртуальных машин

## Part 8*. Знакомство с SSH Tunnels

Запустим на r2 фаервол с правилами из Части 7
![52.png](images/52.png)

*************************************************************************************************************************
Запустим веб-сервер Apache на ws22 только на localhost (то есть в файле /etc/apache2/ports.conf изменим строку Listen 80 на Listen localhost:80)
![53.png](images/53.png)

*************************************************************************************************************************
Воспользуемся Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21. 
ssh -L [local_port]:localhost:80 [remote_ip]
![54.png](images/54.png)

Для выхода необходимо набрать EXIT в терминале
*************************************************************************************************************************
Воспользуемся Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11
ssh -R [remote_port]:localhost:80 [remote_ip]
![55.png](images/55.png)

Для выхода необходимо набрать EXIT в терминале
*************************************************************************************************************************
Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдем во второй терминал клавишами Alt + F2 и выполним команду:
telnet 127.0.0.1 80
![56.png](images/56.png)

*************************************************************************************************************************
Сохраним дампы образов виртуальных машин
